% to make either surface plots of the 2d response kernels or keep them as
% topo maps but with better color schemes

% function visualizeCandK(Inp)

%MH strengths
aE = Inp.aE;
aI = 4*Inp.aI;

% Inp.aI = aI;

%MH for response kernel -- slow
sEk = Inp.sigE;
sIk = Inp.sigI;

%kronecker-delta respnse kernel -- fast
sFk = Inp.sigf;
af = Inp.af;

%MH for correlations -- slow
sEc = Inp.sEc;
sIc = Inp.sIc;

%MH for correlations -- fast
sEc2 = Inp.sEc2;
sIc2 = Inp.sIc2;

%scales the slow down
a_s = Inp.a_s;
ac = Inp.ac;

Inp.nDim = 128;
Inp.nV1 = Inp.nDim^Inp.d;
Inp.nThal = Inp.nDim^Inp.d;
Inp.nDimV1 = Inp.nDim;
Inp.nDimLGN = Inp.nDim;


[distV1sq, Xdist] = neurDistMill(Inp.nDim, Inp.d, Inp.L, Inp.PBC, 0); %putting a random number as the 5th variable uses globaldist to find the distance. So distV1sq is then nV1 x nThal instead of nDimV1 x nDimLGN
distV1 = sqrt(distV1sq);
Inp.distV1 = distV1;
Inp.Xdist = Xdist; 

%arbor 
[A,~,~,~,Nx_arbor] = Arbor2(Xdist, Inp.R_arbor, Inp.d, Inp.nDim, Inp.nDim, Inp.L, Inp.c_a, 0); %R_arbor = radius of the arbor, c_a = scale factor for the other circle (see Miller 94)
Inp.A = A;
Inp.Nx_arbor = Nx_arbor;

% [Cnn, Cnn_fast, e1RF, e2RF, e3RF] = linearC_pc(Inp);

Cnn = makeMexHat2(distV1,sEc,aE,sIc,aI/4,Inp.d, Inp.MILL94);
Cnn_fast = makeMexHat2(distV1, sEc2, aE, sIc2, aI/4, Inp.d, Inp.MILL94);
% Gs = globalDist(Gs, nDimV1, d);

%slow response kernel
Ks = makeMexHat2(distV1,sEk,aE,sIk,aI,Inp.d, Inp.MILL94);
% Gs = globalDist(Gs, nDimV1, d);
Ks(distV1 ~= 0) = a_s*Ks(distV1~=0);

if length(Ks) < Inp.nV1
    sKs = svds(Ks, 1);
else
    sKs = svds(reshape(Ks(1,:),nDimV1,nDimV1),1);
end


if sKs ~= 1
    Ks = 1/sKs * Ks;
end

%fast response kernel
Kf = makeMexHat2(distV1,sFk,af,0,0,Inp.d, Inp.MILL94);

if length(Kf) < length(Ks)
    Kf = globalDist(Kf, nDimV1, d);
end

if length(Kf) < Inp.nV1
    sKf = svds(Kf, 1);
else
    sKf = svds(reshape(Kf(1,:),nDimV1,nDimV1),1);
end


if sKf ~= 1
    Kf = 1/sKf * Kf;
end

Kslow = fftshift(Ks)/max(Ks(:));
Kfast = fftshift(Kf)/max(Kf(:));
Cslow = fftshift(Cnn)/max(Cnn(:));
% Cslow = rescale(Cslow, min(Kslow(:)), 1);
Cfast = fftshift(Cnn_fast)/max(Cnn_fast(:));%*(min(Kslow(:))/min(Cslow(:)));
% Cfast = rescale(Cfast, min(Kslow(:)), 1);

cmin = min([Kslow(:); Kfast(:); Cslow(:); Cfast(:)])
cmax = max([Kslow(:); Kfast(:); Cslow(:); Cfast(:)])

zoominds = 32:96;

figure(8)
subplot(2,2,1)
surf(Kslow(zoominds, zoominds));
shading interp
set(gca,'CLim',[-0.244117611584984 1],'Colormap',...
    [0 1 1;0 0.809523820877075 1;0 0.714285731315613 1;0 0.61904764175415 1;0 0.523809552192688 1;0 0.428571432828903 1;0 0.333333343267441 1;0 0.238095238804817 1;0 0.142857149243355 1;0 0.0476190485060215 1;0.107583768665791 0.139329805970192 0.78483247756958;0.215167537331581 0.231040552258492 0.569664895534515;0.322751313447952 0.322751313447952 0.354497343301773;0.354497343301773 0.322751313447952 0.322751313447952;0.566137552261353 0.216931208968163 0.216931208968163;0.777777791023254 0.111111104488373 0.111111104488373;0.989417970180511 0.00529100513085723 0.00529100513085723;0.989898979663849 0.00721500720828772 0.0050505050458014;0.990379989147186 0.00913900882005692 0.00481000449508429;0.990860998630524 0.0110630113631487 0.00456950441002846;0.991341948509216 0.0129870129749179 0.00432900432497263;0.991822957992554 0.0149110145866871 0.00408850377425551;0.992303967475891 0.0168350171297789 0.00384800368919969;0.992784976959229 0.0187590196728706 0.00360750360414386;0.993265986442566 0.0206830203533173 0.00336700328625739;0.993746995925903 0.022607022896409 0.00312650296837091;0.994228005409241 0.0245310254395008 0.00288600288331509;0.994709014892578 0.0264550261199474 0.00264550256542861;0.995189964771271 0.0283790286630392 0.00240500224754214;0.995670974254608 0.030303031206131 0.00216450216248631;0.996151983737946 0.0322270318865776 0.00192400184459984;0.996632993221283 0.0341510362923145 0.00168350164312869;0.99711400270462 0.0360750369727612 0.00144300144165754;0.997595012187958 0.0379990376532078 0.00120250112377107;0.998076021671295 0.0399230420589447 0.000962000922299922;0.998556971549988 0.0418470427393913 0.000721500720828772;0.999037981033325 0.043771043419838 0.000481000461149961;0.999518990516663 0.0456950478255749 0.00024050023057498;1 0.0476190485060215 0;1 0.0857142880558968 0;1 0.123809523880482 0;1 0.161904767155647 0;1 0.200000002980232 0;1 0.238095238804817 0;1 0.276190489530563 0;1 0.314285725355148 0;1 0.352380961179733 0;1 0.390476197004318 0;1 0.428571432828903 0;1 0.466666668653488 0;1 0.504761934280396 0;1 0.54285717010498 0;1 0.580952405929565 0;1 0.61904764175415 0;1 0.657142877578735 0;1 0.69523811340332 0;1 0.733333349227905 0;1 0.77142858505249 0;1 0.809523820877075 0;1 0.84761905670166 0;1 0.885714292526245 0;1 0.92380952835083 0;1 0.961904764175415 0;1 1 0])
%caxis([cmin, cmax])
%colormap(bipolar);
colorbar
xticks([]);
yticks([]);
zticks([]);

subplot(2,2,2)
surf(Kfast(zoominds, zoominds));
set(gca,'CLim',[-0.244117611584984 1],'Colormap',...
    [0 1 1;0 0.809523820877075 1;0 0.714285731315613 1;0 0.61904764175415 1;0 0.523809552192688 1;0 0.428571432828903 1;0 0.333333343267441 1;0 0.238095238804817 1;0 0.142857149243355 1;0 0.0476190485060215 1;0.107583768665791 0.139329805970192 0.78483247756958;0.215167537331581 0.231040552258492 0.569664895534515;0.322751313447952 0.322751313447952 0.354497343301773;0.354497343301773 0.322751313447952 0.322751313447952;0.566137552261353 0.216931208968163 0.216931208968163;0.777777791023254 0.111111104488373 0.111111104488373;0.989417970180511 0.00529100513085723 0.00529100513085723;0.989898979663849 0.00721500720828772 0.0050505050458014;0.990379989147186 0.00913900882005692 0.00481000449508429;0.990860998630524 0.0110630113631487 0.00456950441002846;0.991341948509216 0.0129870129749179 0.00432900432497263;0.991822957992554 0.0149110145866871 0.00408850377425551;0.992303967475891 0.0168350171297789 0.00384800368919969;0.992784976959229 0.0187590196728706 0.00360750360414386;0.993265986442566 0.0206830203533173 0.00336700328625739;0.993746995925903 0.022607022896409 0.00312650296837091;0.994228005409241 0.0245310254395008 0.00288600288331509;0.994709014892578 0.0264550261199474 0.00264550256542861;0.995189964771271 0.0283790286630392 0.00240500224754214;0.995670974254608 0.030303031206131 0.00216450216248631;0.996151983737946 0.0322270318865776 0.00192400184459984;0.996632993221283 0.0341510362923145 0.00168350164312869;0.99711400270462 0.0360750369727612 0.00144300144165754;0.997595012187958 0.0379990376532078 0.00120250112377107;0.998076021671295 0.0399230420589447 0.000962000922299922;0.998556971549988 0.0418470427393913 0.000721500720828772;0.999037981033325 0.043771043419838 0.000481000461149961;0.999518990516663 0.0456950478255749 0.00024050023057498;1 0.0476190485060215 0;1 0.0857142880558968 0;1 0.123809523880482 0;1 0.161904767155647 0;1 0.200000002980232 0;1 0.238095238804817 0;1 0.276190489530563 0;1 0.314285725355148 0;1 0.352380961179733 0;1 0.390476197004318 0;1 0.428571432828903 0;1 0.466666668653488 0;1 0.504761934280396 0;1 0.54285717010498 0;1 0.580952405929565 0;1 0.61904764175415 0;1 0.657142877578735 0;1 0.69523811340332 0;1 0.733333349227905 0;1 0.77142858505249 0;1 0.809523820877075 0;1 0.84761905670166 0;1 0.885714292526245 0;1 0.92380952835083 0;1 0.961904764175415 0;1 1 0])
shading interp
%caxis([cmin, cmax])
%colormap(bipolar);
colorbar
xticks([]);
yticks([]);
zticks([]);

subplot(2,2,3)
surf(Cslow(zoominds, zoominds));
set(gca,'CLim',[-0.244117611584984 1],'Colormap',...
    [0 1 1;0 0.809523820877075 1;0 0.714285731315613 1;0 0.61904764175415 1;0 0.523809552192688 1;0 0.428571432828903 1;0 0.333333343267441 1;0 0.238095238804817 1;0 0.142857149243355 1;0 0.0476190485060215 1;0.107583768665791 0.139329805970192 0.78483247756958;0.215167537331581 0.231040552258492 0.569664895534515;0.322751313447952 0.322751313447952 0.354497343301773;0.354497343301773 0.322751313447952 0.322751313447952;0.566137552261353 0.216931208968163 0.216931208968163;0.777777791023254 0.111111104488373 0.111111104488373;0.989417970180511 0.00529100513085723 0.00529100513085723;0.989898979663849 0.00721500720828772 0.0050505050458014;0.990379989147186 0.00913900882005692 0.00481000449508429;0.990860998630524 0.0110630113631487 0.00456950441002846;0.991341948509216 0.0129870129749179 0.00432900432497263;0.991822957992554 0.0149110145866871 0.00408850377425551;0.992303967475891 0.0168350171297789 0.00384800368919969;0.992784976959229 0.0187590196728706 0.00360750360414386;0.993265986442566 0.0206830203533173 0.00336700328625739;0.993746995925903 0.022607022896409 0.00312650296837091;0.994228005409241 0.0245310254395008 0.00288600288331509;0.994709014892578 0.0264550261199474 0.00264550256542861;0.995189964771271 0.0283790286630392 0.00240500224754214;0.995670974254608 0.030303031206131 0.00216450216248631;0.996151983737946 0.0322270318865776 0.00192400184459984;0.996632993221283 0.0341510362923145 0.00168350164312869;0.99711400270462 0.0360750369727612 0.00144300144165754;0.997595012187958 0.0379990376532078 0.00120250112377107;0.998076021671295 0.0399230420589447 0.000962000922299922;0.998556971549988 0.0418470427393913 0.000721500720828772;0.999037981033325 0.043771043419838 0.000481000461149961;0.999518990516663 0.0456950478255749 0.00024050023057498;1 0.0476190485060215 0;1 0.0857142880558968 0;1 0.123809523880482 0;1 0.161904767155647 0;1 0.200000002980232 0;1 0.238095238804817 0;1 0.276190489530563 0;1 0.314285725355148 0;1 0.352380961179733 0;1 0.390476197004318 0;1 0.428571432828903 0;1 0.466666668653488 0;1 0.504761934280396 0;1 0.54285717010498 0;1 0.580952405929565 0;1 0.61904764175415 0;1 0.657142877578735 0;1 0.69523811340332 0;1 0.733333349227905 0;1 0.77142858505249 0;1 0.809523820877075 0;1 0.84761905670166 0;1 0.885714292526245 0;1 0.92380952835083 0;1 0.961904764175415 0;1 1 0])
shading interp
%caxis([cmin, cmax])
%colormap(bipolar);
colorbar
box off
xticks([]);
yticks([]);
zticks([]);

subplot(2,2,4)
surf(Cfast(zoominds, zoominds));
set(gca,'CLim',[-0.244117611584984 1],'Colormap',...
    [0 1 1;0 0.809523820877075 1;0 0.714285731315613 1;0 0.61904764175415 1;0 0.523809552192688 1;0 0.428571432828903 1;0 0.333333343267441 1;0 0.238095238804817 1;0 0.142857149243355 1;0 0.0476190485060215 1;0.107583768665791 0.139329805970192 0.78483247756958;0.215167537331581 0.231040552258492 0.569664895534515;0.322751313447952 0.322751313447952 0.354497343301773;0.354497343301773 0.322751313447952 0.322751313447952;0.566137552261353 0.216931208968163 0.216931208968163;0.777777791023254 0.111111104488373 0.111111104488373;0.989417970180511 0.00529100513085723 0.00529100513085723;0.989898979663849 0.00721500720828772 0.0050505050458014;0.990379989147186 0.00913900882005692 0.00481000449508429;0.990860998630524 0.0110630113631487 0.00456950441002846;0.991341948509216 0.0129870129749179 0.00432900432497263;0.991822957992554 0.0149110145866871 0.00408850377425551;0.992303967475891 0.0168350171297789 0.00384800368919969;0.992784976959229 0.0187590196728706 0.00360750360414386;0.993265986442566 0.0206830203533173 0.00336700328625739;0.993746995925903 0.022607022896409 0.00312650296837091;0.994228005409241 0.0245310254395008 0.00288600288331509;0.994709014892578 0.0264550261199474 0.00264550256542861;0.995189964771271 0.0283790286630392 0.00240500224754214;0.995670974254608 0.030303031206131 0.00216450216248631;0.996151983737946 0.0322270318865776 0.00192400184459984;0.996632993221283 0.0341510362923145 0.00168350164312869;0.99711400270462 0.0360750369727612 0.00144300144165754;0.997595012187958 0.0379990376532078 0.00120250112377107;0.998076021671295 0.0399230420589447 0.000962000922299922;0.998556971549988 0.0418470427393913 0.000721500720828772;0.999037981033325 0.043771043419838 0.000481000461149961;0.999518990516663 0.0456950478255749 0.00024050023057498;1 0.0476190485060215 0;1 0.0857142880558968 0;1 0.123809523880482 0;1 0.161904767155647 0;1 0.200000002980232 0;1 0.238095238804817 0;1 0.276190489530563 0;1 0.314285725355148 0;1 0.352380961179733 0;1 0.390476197004318 0;1 0.428571432828903 0;1 0.466666668653488 0;1 0.504761934280396 0;1 0.54285717010498 0;1 0.580952405929565 0;1 0.61904764175415 0;1 0.657142877578735 0;1 0.69523811340332 0;1 0.733333349227905 0;1 0.77142858505249 0;1 0.809523820877075 0;1 0.84761905670166 0;1 0.885714292526245 0;1 0.92380952835083 0;1 0.961904764175415 0;1 1 0])
shading interp
%caxis([cmin, cmax])
%colormap(bipolar);
box off
colorbar
xticks([]);
yticks([]);
zticks([]);